rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin (simplified for now, 
    // ideally check custom claims or a user document role)
    // Helper function to check if user is admin
    // LOGIC: Existing Admins don't have a 'users' doc. Natives DO.
    // So if you are authenticated AND (don't have a user doc OR your user doc is not native), you are Admin.
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && (
        request.auth.token.email == 'klenamtheophilus@gmail.com' ||
        request.auth.token.email == 'afifetownweb@gmail.com'
      );
    }
    
    // Helper to check if the user is the owner of the data
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Public Collections (Read Public, Write Admin)
    match /news/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /events/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /market/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    match /projects/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /directory/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /alerts/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /meetings/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Native Users Collection
    match /users/{userId} {
      allow create: if isOwner(userId);
      // Explicitly allow owner read without isAdmin check to prevent potential circular logic or overhead
      allow read: if isOwner(userId) || isAdmin();
      allow update: if isOwner(userId) || isAdmin();
    }

    // Permits (User owns, Admin manages)
    match /permits/{document=**} {
      allow create: if isOwner(request.resource.data.userId);
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow update: if isAdmin();
    }

    // Requests (Chat) (User owns, Admin manages)
    match /requests/{document=**} {
      allow create: if isOwner(request.resource.data.userId) || isAdmin();
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow update: if isOwner(resource.data.userId) || isAdmin();
    }

    // Suggestions (Public Read/Create/Upvote, Admin Delete)
    match /suggestions/{document=**} {
      allow read, create: if true;
      // Allow upvoting (updating the upvotes field)
      allow update: if true; 
      allow delete: if isAdmin();
    }

    // Submissions (Public Create, Admin Read/Update)
    match /submissions/{document=**} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    // Portal Activities (User owns, Admin Read)
    match /portal_activities/{document=**} {
      allow create: if request.auth != null;
      allow read: if isOwner(resource.data.userId) || isAdmin();
    }

    // Jobs and Adverts (Public Read, Admin Manage)
    match /jobs/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /adverts/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Job Applications (User creates, Admin manages)
    match /job_applications/{document=**} {
      allow create: if true;
      allow read, write: if isAdmin();
    }

    // Community Polls
    match /polls/{pollId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isAdmin();

      match /votes/{userId} {
        allow create, update: if isOwner(userId);
        allow read: if isAdmin() || isOwner(userId);
      }
    }

    // Admin Notifications
    match /admin_notifications/{document=**} {
      allow create: if request.auth != null;
      allow read, update, delete: if isAdmin();
    }

    // Mail Collection (for Trigger Email extension)
    match /mail/{document=**} {
      allow create: if request.auth != null;
      allow read, write: if isAdmin();
    }
    
    // Gallery Collection
    match /gallery/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Default Deny
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
